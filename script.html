<script type="module">
    // --- Firebase ëª¨ë“ˆ ì„í¬íŠ¸ ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove, deleteDoc, writeBatch, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Firebase ì„¤ì • ---
    const firebaseConfig = {
        apiKey: "AIzaSyB6AzqMt0CByFHu5_YQxltGAK3n8jW_Bmo",
        authDomain: "imagine-sentences-class.firebaseapp.com",
        projectId: "imagine-sentences-class",
        storageBucket: "imagine-sentences-class.firebasestorage.app",
        messagingSenderId: "863169353628",
        appId: "1:863169353628:web:b00aa7caedee1090f99a59",
        measurementId: "G-EQVSNH407N"
    };

    // --- ì „ì—­ ë³€ìˆ˜ ë° HTML ìš”ì†Œ ---
    let db, auth, currentUser, currentClassId = null;
    let activeListeners = [];

    // í™”ë©´ ìš”ì†Œ
    const loginContainer = document.getElementById('login-container');
    const dashboardContainer = document.getElementById('dashboard-container');
    const exportContent = document.getElementById('export-content');

    // ëŒ€ì‹œë³´ë“œ ìš”ì†Œ
    const googleLoginBtn = document.getElementById('google-login-btn');
    const dashboardWelcome = document.getElementById('dashboard-welcome');
    const logoutBtn = document.getElementById('logout-btn');
    const newClassNameInput = document.getElementById('new-class-name-input');
    const addClassBtn = document.getElementById('add-class-btn');
    const classroomList = document.getElementById('classroom-list');

    // í™œë™ í˜ì´ì§€ ìš”ì†Œ
    const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');
    const imageContainer = document.getElementById('image-container');
    const wordActivitySection = document.getElementById('word-activity-section');
    const sentenceActivitySection = document.getElementById('sentence-activity-section');
    const sentencesFeed = document.getElementById('sentences-feed');
    const wordForm = document.getElementById('word-form');
    const wordInput = document.getElementById('word-input');
    const sentenceForm = document.getElementById('sentence-form');
    const sentenceInput = document.getElementById('sentence-input');
    const authorNameInput = document.getElementById('author-name-input');
    const wordCloudFeed = document.getElementById('word-cloud-feed');
    const teacherControls = document.getElementById('teacher-controls');
    const startActivityBtn = document.getElementById('start-activity-btn');
    const activateWordInputBtn = document.getElementById('activate-word-input-btn');
    const activateSentenceInputBtn = document.getElementById('activate-sentence-input-btn');
    const getAiInspirationBtn = document.getElementById('get-ai-inspiration-btn');
    const aiHelperDiv = document.getElementById('ai-helper');
    const aiOutputDiv = document.getElementById('ai-output');
    const exportPdfBtn = document.getElementById('export-pdf-btn');
    const exportCsvBtn = document.getElementById('export-csv-btn');
    const toastNotification = document.getElementById('toast-notification');

    // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
    const showToast = (message, isError = false) => {
        toastNotification.textContent = message;
        toastNotification.style.backgroundColor = isError ? '#ef4444' : '#22c55e';
        toastNotification.classList.add('show');
        setTimeout(() => toastNotification.classList.remove('show'), 3000);
    };

    const showScreen = (screenId) => {
        loginContainer.classList.add('hidden');
        dashboardContainer.classList.add('hidden');
        exportContent.classList.add('hidden');

        const screenToShow = document.getElementById(screenId);
        if (screenToShow) {
            screenToShow.classList.remove('hidden');
        }
    };

    const generateJoinCode = (length = 6) => {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let result = '';
        for (let i = 0; i < length; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    };

    const saveUserToFirestore = async (user) => {
        const userRef = doc(db, "users", user.uid);
        const userData = {
            uid: user.uid,
            email: user.email,
            displayName: user.displayName,
            photoURL: user.photoURL,
            lastLogin: serverTimestamp() // ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì‹œê°„ ê¸°ë¡
        };
        await setDoc(userRef, userData, { merge: true }); // ì—†ìœ¼ë©´ ìƒì„±, ìˆìœ¼ë©´ ë³‘í•©
    };

    // --- ëŒ€ì‹œë³´ë“œ ê´€ë ¨ í•¨ìˆ˜ ---
    const setupDashboardUI = (user) => {
        dashboardWelcome.textContent = `${user.displayName}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤.`;
        displayUserClasses(user.uid);
    };

    const displayUserClasses = (userId) => {
        const q = query(collection(db, "classrooms"), where("teacherId", "==", userId), where("createdAt", "!=", null));

        onSnapshot(q, (snapshot) => {
            if (snapshot.empty) {
                classroomList.innerHTML = '<p class="text-gray-500 text-center py-4">ì•„ì§ ìƒì„±ëœ í´ë˜ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            classroomList.innerHTML = '';
            snapshot.docs.sort((a, b) => b.data().createdAt - a.data().createdAt).forEach(doc => {
                const classroom = doc.data();
                const classId = doc.id;
                const classEl = document.createElement('div');
                classEl.className = 'flex justify-between items-center bg-gray-50 p-4 rounded-lg border';
                classEl.innerHTML = `
                <div>
                    <h4 class="font-bold text-lg">${classroom.className}</h4>
                    <p class="text-sm text-gray-500">ì°¸ì—¬ ì½”ë“œ: <span class="font-mono bg-gray-200 px-2 py-1 rounded">${classroom.joinCode}</span></p>
                </div>
                <div class="flex gap-2">
                    <button class="enter-class-btn bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700" data-id="${classId}">ì…ì¥</button>
                    <button class="delete-class-btn bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700" data-id="${classId}">ì‚­ì œ</button>
                </div>
            `;
                classroomList.appendChild(classEl);
            });
        });
    };

    // --- [ì¬í†µí•©] í™œë™ í˜ì´ì§€ ê´€ë ¨ í•¨ìˆ˜ë“¤ (classId ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •ë¨) ---
    const cleanupListeners = () => {
        activeListeners.forEach(unsub => unsub());
        activeListeners = [];
    };

    const updatePhase = async (classId, phase) => {
        const appStateRef = doc(db, `classrooms/${classId}/appState/current`);
        await setDoc(appStateRef, { currentPhase: phase, updatedAt: serverTimestamp() });
    };

    const listenForAppState = (classId) => {
        const appStateRef = doc(db, `classrooms/${classId}/appState/current`);
        const unsubscribe = onSnapshot(appStateRef, (docSnapshot) => {
            const phase = docSnapshot.exists() ? docSnapshot.data().currentPhase : 'waiting';
            imageContainer.classList.add('hidden');
            wordActivitySection.classList.add('hidden');
            sentenceActivitySection.classList.add('hidden');
            activateWordInputBtn.disabled = true;
            activateSentenceInputBtn.disabled = true;
            switch (phase) {
                case 'images_only': imageContainer.classList.remove('hidden'); activateWordInputBtn.disabled = false; break;
                case 'word_input_active': imageContainer.classList.remove('hidden'); wordActivitySection.classList.remove('hidden'); activateSentenceInputBtn.disabled = false; break;
                case 'sentence_input_active': imageContainer.classList.remove('hidden'); wordActivitySection.classList.remove('hidden'); sentenceActivitySection.classList.remove('hidden'); break;
            }
        });
        activeListeners.push(unsubscribe);
    };

    const listenForSharedImages = (classId) => {
        const imageDocRef = doc(db, `classrooms/${classId}/sharedImages/current`);
        const unsubscribe = onSnapshot(imageDocRef, (doc) => {
            imageContainer.innerHTML = '';
            if (doc.exists()) {
                const data = doc.data();
                const img1 = document.createElement('img'); img1.src = data.url1; img1.alt = data.alt1; img1.className = 'w-full h-full object-cover rounded-lg shadow-md';
                const img2 = document.createElement('img'); img2.src = data.url2; img2.alt = data.alt2; img2.className = 'w-full h-full object-cover rounded-lg shadow-md';
                imageContainer.append(img1, img2);
            } else {
                imageContainer.innerHTML = `<div class="col-span-2 bg-gray-200 aspect-video rounded-lg flex items-center justify-center p-4 text-center"><p class="text-gray-500">ì„ ìƒë‹˜ì´ 'í™œë™ ì‹œì‘' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì‚¬ì§„ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p></div>`;
            }
        });
        activeListeners.push(unsubscribe);
    };

    const listenForAiHelper = (classId) => {
        const aiHelperDocRef = doc(db, `classrooms/${classId}/aiHelper/current`);
        onSnapshot(aiHelperDocRef, (doc) => {
            if (doc.exists() && doc.data().content) {
                let content = doc.data().content;
                let htmlOutput = '';

                try {
                    // AI ì‘ë‹µì— í¬í•¨ë  ìˆ˜ ìˆëŠ” ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡(```json ... ```)ì„ ì œê±°í•©ë‹ˆë‹¤.
                    if (content.startsWith("```json")) {
                        content = content.substring(7, content.length - 3).trim();
                    } else if (content.startsWith("```")) {
                        content = content.substring(3, content.length - 3).trim();
                    }

                    const aiData = JSON.parse(content);

                    if (aiData.exampleSentence && aiData.theme1 && aiData.theme2) {
                        htmlOutput += '<h4 class="text-md font-bold text-purple-700 mb-2">ğŸ”‘ ê´€ë ¨ í‚¤ì›Œë“œ</h4>';
                        htmlOutput += '<div class="flex flex-wrap gap-2">';

                        const allKeywords = [...aiData.theme1, ...aiData.theme2];
                        allKeywords.forEach(keyword => {
                            htmlOutput += `<span class="keyword-tag">${keyword}</span>`;
                        });
                        htmlOutput += '</div>';
                        htmlOutput += `
                    <h4 class="text-md font-bold text-purple-700 mb-2">ğŸ’¡ AI ì¶”ì²œ ë¬¸ì¥</h4>
                    <p class="mb-4 p-3 bg-white rounded-md shadow-sm">${aiData.exampleSentence}</p>
                `;
                        aiOutputDiv.innerHTML = htmlOutput;
                    } else {
                        throw new Error("Invalid AI data structure.");
                    }
                } catch (e) {
                    console.error("Could not parse AI helper content, displaying as raw text:", e);
                    // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ì›ë³¸ í…ìŠ¤íŠ¸ë¥¼ ë³´ì—¬ì£¼ì–´ ì–´ë–¤ ë‚´ìš©ì´ ì™”ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
                    aiOutputDiv.innerHTML = `<p class="text-gray-700 whitespace-pre-wrap">${doc.data().content}</p>`;
                }

                aiHelperDiv.classList.remove('hidden');
            } else {
                aiHelperDiv.classList.add('hidden');
            }
        });
    };

    const listenForWords = (classId) => {
        const wordsCol = collection(db, `classrooms/${classId}/words`);
        const unsubscribe = onSnapshot(query(wordsCol), (snapshot) => { /* ... ê¸°ì¡´ê³¼ ê±°ì˜ ë™ì¼ ... */ });
        activeListeners.push(unsubscribe);
    };

    const listenForSentences = (classId) => {
        const sentencesCol = collection(db, `classrooms/${classId}/sentences`);
        const unsubscribe = onSnapshot(query(sentencesCol), (snapshot) => { /* ... ê¸°ì¡´ê³¼ ê±°ì˜ ë™ì¼ (userId -> currentUser.uid) ... */ });
        activeListeners.push(unsubscribe);
    };

    // ... ë‚˜ë¨¸ì§€ í™œë™ í•¨ìˆ˜ë“¤(handleFormSubmit, handleLikeClick ë“±)ë„
    // ë‚´ë¶€ì—ì„œ currentClassId ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ê²½ë¡œë¥¼ ì§€ì •í•˜ë„ë¡ ìˆ˜ì •ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
    // (ì•„ë˜ main í•¨ìˆ˜ ë¡œì§ì— ë°˜ì˜ë¨)

    // --- [ìˆ˜ì •ë¨] í´ë˜ìŠ¤ ì…ì¥ í•¨ìˆ˜ ---
    const enterClassroom = (classId) => {
        currentClassId = classId;
        cleanupListeners(); // ëŒ€ì‹œë³´ë“œ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬

        showScreen('export-content');
        teacherControls.classList.remove('hidden');

        // í˜„ì¬ í´ë˜ìŠ¤ì— ëŒ€í•œ ë¦¬ìŠ¤ë„ˆë“¤ í™œì„±í™”
        listenForAppState(classId);
        listenForSharedImages(classId);
        listenForWords(classId);
        listenForSentences(classId);
        listenForAiHelper(classId); // í•„ìš” ì‹œ ì¶”ê°€
    };

    // --- ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜ ---
    const main = async () => {
        try {
            initializeApp(firebaseConfig);
            db = getFirestore();
            auth = getAuth();
        } catch (e) { console.error("Firebase init failed:", e); }

        // 1. ì „ì—­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        googleLoginBtn.addEventListener('click', () => {
            signInWithPopup(auth, new GoogleAuthProvider()).catch(error => {
                if (error.code !== 'auth/popup-closed-by-user') {
                    console.error("Google sign-in error", error);
                }
            });
        });
        logoutBtn.addEventListener('click', () => signOut(auth));
        addClassBtn.addEventListener('click', async () => {
            const className = newClassNameInput.value.trim();
            if (className && currentUser) {
                try {
                    await addDoc(collection(db, "classrooms"), {
                        className: className,
                        teacherId: currentUser.uid,
                        joinCode: generateJoinCode(),
                        createdAt: serverTimestamp()
                    });
                    newClassNameInput.value = '';
                } catch (error) {
                    console.error("Error creating classroom: ", error);
                    alert("í´ë˜ìŠ¤ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            } else if (!className) {
                alert("í´ë˜ìŠ¤ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            }
        });

        // ëŒ€ì‹œë³´ë“œ ë‚´ í´ë˜ìŠ¤ ëª©ë¡ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        classroomList.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const classId = button.dataset.id;
            if (button.classList.contains('delete-class-btn')) {
                if (confirm("ì •ë§ë¡œ ì´ í´ë˜ìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) deleteDoc(doc(db, "classrooms", classId));
            } else if (button.classList.contains('enter-class-btn')) {
                enterClassroom(classId); // í´ë˜ìŠ¤ ì…ì¥ í•¨ìˆ˜ í˜¸ì¶œ
            }
        });

        // í™œë™ í˜ì´ì§€ ë‚´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        backToDashboardBtn.addEventListener('click', () => {
            cleanupListeners();
            currentClassId = null;
            setupDashboardUI(currentUser); // ëŒ€ì‹œë³´ë“œ ë¦¬ìŠ¤ë„ˆ ì¬ì„¤ì •
            showScreen('dashboard-container');
        });

        startActivityBtn.addEventListener('click', async () => {
            if (!currentClassId) return;
            // fetchAndSetNewSharedImages(currentClassId); // Netlify function ì—°ë™ ì‹œ í™œì„±í™”
            alert("'í™œë™ ì‹œì‘' ê¸°ëŠ¥ì€ Netlify í•¨ìˆ˜ì™€ ì—°ë™ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        });

        wordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentClassId || !currentUser) return;
            const wordText = wordInput.value.trim();
            if (wordText) {
                await addDoc(collection(db, `classrooms/${currentClassId}/words`), {
                    text: wordText, createdAt: serverTimestamp(), authorId: currentUser.uid,
                });
                wordInput.value = '';
            }
        });

        sentenceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentClassId || !currentUser) return;
            const sentenceText = sentenceInput.value.trim();
            const authorName = authorNameInput.value.trim() || 'ìµëª…';
            if (sentenceText) {
                await addDoc(collection(db, `classrooms/${currentClassId}/sentences`), {
                    text: sentenceText, authorName: authorName, createdAt: serverTimestamp(), authorId: currentUser.uid, likesBy: []
                });
                sentenceInput.value = '';
            }
        });

        sentencesFeed.addEventListener('click', async (e) => {
            const button = e.target.closest('.like-btn');
            if (!button || !currentUser || !currentClassId) return;
            const sentenceId = button.dataset.id;
            const sentenceRef = doc(db, `classrooms/${currentClassId}/sentences`, sentenceId);
            const docSnap = await getDoc(sentenceRef);
            if (docSnap.exists()) {
                const likesBy = docSnap.data().likesBy || [];
                if (likesBy.includes(currentUser.uid)) {
                    await updateDoc(sentenceRef, { likesBy: arrayRemove(currentUser.uid) });
                } else {
                    await updateDoc(sentenceRef, { likesBy: arrayUnion(currentUser.uid) });
                }
            }
        });


        // 2. ì¸ì¦ ìƒíƒœ ë³€í™” ê°ì§€
        onAuthStateChanged(auth, async (user) => {
            cleanupListeners();
            if (user) {
                currentUser = user;
                await saveUserToFirestore(user);
                setupDashboardUI(user);
                showScreen('dashboard-container');
            } else {
                currentUser = null;
                showScreen('login-container');
            }
        });
    };

    main();
</script>